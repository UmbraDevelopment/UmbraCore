# Enable bzlmod
common --enable_bzlmod

# Platform configuration
build --apple_platform_type=macos
build --macos_minimum_os=14.0
build --cpu=darwin_arm64
build --apple_crosstool_top=@local_config_apple_cc//:toolchain
build --crosstool_top=@local_config_apple_cc//:toolchain
build --host_crosstool_top=@local_config_apple_cc//:toolchain

# Test configuration
test --test_output=all
test --test_env=DYLD_LIBRARY_PATH
test --test_env=DYLD_FRAMEWORK_PATH
test --test_env=DEVELOPER_DIR
test --test_env=SWIFT_DETERMINISTIC_HASHING=1
test --test_env=SDKROOT
test --test_env=MACOS_SDK_VERSION=14.0
test --test_env=XCODE_VERSION_OVERRIDE=15.0.0
test --test_env=PLATFORM_NAME=macosx
test --test_verbose_timeout_warnings
test --test_summary=detailed
test --build_tests_only

# Swift specific settings
build --features=swift.use_global_module_cache
build --features=swift.enable_batch_mode
build --features=swift.enable_concurrency_checking
build --features=swift.use_global_index_store

# C++ settings for crypto dependencies
build --cxxopt=-std=c++14

# Environment setup
build --action_env=PATH
build --action_env=CC=clang

# Cache settings
build --disk_cache=~/.cache/bazel
build --repository_cache=~/.cache/bazel-repo

# Coverage settings
coverage --instrument_test_targets
coverage --combined_report=lcov
coverage --coverage_report_generator=@bazel_tools//tools/test/CoverageOutputGenerator/java/com/google/devtools/coverageoutputgenerator:Main
coverage --instrumentation_filter="^//Sources"

# Performance optimizations
build --incompatible_strict_action_env
build --remote_local_fallback

# Build configurations
build:debug -c dbg
build:debug --swiftcopt=-g
build:debug --swiftcopt=-Onone
build:debug --swiftcopt=-enable-testing
build:debug --swiftcopt=-DDEBUG

build:release -c opt
build:release --swiftcopt=-O
build:release --swiftcopt=-whole-module-optimization

# Import local settings (must be last)
try-import %workspace%/user.bazelrc
try-import %workspace%/.bazelrc.local
